<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸‚åœº - SunPixel</title>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2ecc71;
            --dark-bg: #1a1a1a;
            --light-bg: #f8f9fa;
            --text-color: #333;
            --text-light: #666;
            --border-color: #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--light-bg);
            color: var(--text-color);
            min-height: 100vh;
        }
        
        /* å¯¼èˆªæ  */
        .navbar {
            background: white;
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .logo h1 {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }
        
        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .nav-links a:hover,
        .nav-links a.active {
            background: var(--primary-color);
            color: white;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info span {
            font-weight: 500;
            color: var(--text-color);
        }
        
        /* ä¸»è¦å†…å®¹ */
        .main-content {
            max-width: 1200px;
            margin: 80px auto 20px;
            padding: 0 20px;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-header h2 {
            font-size: 28px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* å¸‚åœºç½‘æ ¼ */
        .market-container {
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .market-header {
            font-size: 22px;
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
        }
        
        .market-header i {
            margin-right: 10px;
        }
        
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .market-item {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            border: 1px solid var(--border-color);
        }
        
        .market-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .market-item-img {
            width: 100%;
            height: 180px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-size: 14px;
        }
        
        .market-item-content {
            padding: 15px;
        }
        
        .market-item h5 {
            margin: 0 0 10px 0;
            font-size: 16px;
            color: var(--primary-color);
        }
        
        .market-item p {
            color: var(--text-light);
            font-size: 14px;
            margin: 0 0 10px 0;
            line-height: 1.5;
        }
        
        .market-item .btn {
            width: 100%;
            margin: 0;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            text-decoration: none;
            text-align: center;
            min-width: 120px;
        }
        
        .btn:hover {
            background: var(--primary-dark);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }
        
        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .market-grid {
                grid-template-columns: 1fr;
            }
            
            .market-container {
                padding: 20px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-sun"></i>
                <h1>SunPixel</h1>
            </div>
            <ul class="nav-links">
                <li><a href="/"><i class="fas fa-home"></i> æ§åˆ¶å°</a></li>
                <li><a href="/history"><i class="fas fa-history"></i> å†å²è®°å½•</a></li>
                <li><a href="/market" class="active"><i class="fas fa-store"></i> å¸‚åœº</a></li>
                <li><a href="/changelog"><i class="fas fa-clipboard-list"></i> æ›´æ–°è®°å½•</a></li>
            </ul>
            <div class="user-info">
                <span id="username">æ¸¸å®¢</span>
                <button class="btn btn-outline btn-sm" id="loginBtn">ç™»å½•</button>
                <button class="btn btn-outline btn-sm" id="logoutBtn" style="display: none;">ç™»å‡º</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="main-content">
        <div class="page-header">
            <h2><i class="fas fa-store"></i> å¸‚åœº</h2>
        </div>
        
        <div class="market-container">
            <div class="market-header">
                <i class="fas fa-shopping-cart me-2"></i> åƒç´ ç”»ä½œå“
            </div>
            
            <div class="market-controls" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div class="search-box">
                    <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢ä½œå“..." style="width: 300px;">
                </div>
                <div class="sort-options">
                    <select class="form-control" id="sortSelect" style="width: auto;">
                        <option value="upload_time">æŒ‰ä¸Šä¼ æ—¶é—´</option>
                        <option value="download_count">æŒ‰ä¸‹è½½é‡</option>
                        <option value="favorites">æŒ‰æ”¶è—æ•°</option>
                        <option value="title">æŒ‰æ ‡é¢˜</option>
                    </select>
                </div>
                <button class="btn" id="uploadMarketBtn" onclick="showUploadModal()">
                    <i class="fas fa-upload"></i> ä¸Šä¼ ä½œå“
                </button>
            </div>
            
            <div class="market-grid" id="marketGrid">
                <!-- åŠ¨æ€åŠ è½½å¸‚åœºé¡¹ç›® -->
                <div id="marketEmpty" class="empty-state" style="display: none;">
                    <i class="fas fa-store"></i>
                    <h3>å¸‚åœºä¸­æš‚æ— ä½œå“</h3>
                    <p>æˆä¸ºç¬¬ä¸€ä¸ªä¸Šä¼ è€…å§ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ ä½œå“æ¨¡æ€æ¡† -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <span class="modal-close" id="closeUploadModal">&times;</span>
            <div class="modal-title">ä¸Šä¼ ä½œå“åˆ°å¸‚åœº</div>
            <form class="upload-form" id="marketUploadForm">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                    <input type="file" class="form-control" id="marketFileInput" accept=".schem,.nbt,.litematic,.json" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ä½œå“æ ‡é¢˜</label>
                    <input type="text" class="form-control" id="marketTitle" placeholder="è¯·è¾“å…¥ä½œå“æ ‡é¢˜" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ä½œå“æè¿°</label>
                    <textarea class="form-control" id="marketDescription" placeholder="è¯·è¾“å…¥ä½œå“æè¿°" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">ä¸Šä¼ ä½œå“</button>
            </form>
        </div>
    </div>

    <!-- ç”¨æˆ·ç»Ÿè®¡æ¨¡æ€æ¡† -->
    <div class="modal" id="userStatsModal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="modal-close" id="closeUserStatsModal">&times;</span>
            <div class="modal-title">ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯</div>
            <div id="userStatsContent">
                <!-- åŠ¨æ€åŠ è½½ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ -->
            </div>
        </div>
    </div>

    <!-- é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal" id="itemModal">
        <div class="modal-content">
            <span class="modal-close" id="closeItemModal">&times;</span>
            <div class="modal-title">ä½œå“è¯¦æƒ…</div>
            <div id="itemDetails">
                <!-- åŠ¨æ€åŠ è½½é¡¹ç›®è¯¦æƒ… -->
            </div>
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="modal-close" id="closeLoginModal">&times;</span>
            <div class="modal-title">ç”¨æˆ·ç™»å½•</div>
            <form class="login-form" id="loginForm">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <input type="text" class="form-control" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit" class="btn">ç™»å½•</button>
                <button type="button" class="btn btn-outline" id="guestLoginBtn">æ¸¸å®¢è®¿é—®</button>
            </form>
        </div>
    </div>

    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    document.getElementById('username').textContent = userData.username;
                    // éšè—ç™»å½•æŒ‰é’®ï¼Œæ˜¾ç¤ºç™»å‡ºæŒ‰é’®
                    document.getElementById('loginBtn').style.display = 'none';
                    document.getElementById('logoutBtn').style.display = 'inline-block';
                } catch (e) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                }
            } else {
                document.getElementById('username').textContent = 'æ¸¸å®¢';
                // æ˜¾ç¤ºç™»å½•æŒ‰é’®ï¼Œéšè—ç™»å‡ºæŒ‰é’®
                document.getElementById('loginBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        // éšè—ç™»å½•æ¨¡æ€æ¡†
        function hideLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
        }

        // å¤„ç†ç™»å½•
        function handleLogin(username, password) {
            // è¿™é‡Œå¯ä»¥å‘åç«¯éªŒè¯ç”¨æˆ·ä¿¡æ¯ï¼Œå½“å‰ä¸ºæ¨¡æ‹Ÿå®ç°
            const userData = {
                username: username,
                password: password, // æ³¨æ„ï¼šå®é™…åº”ç”¨ä¸­ä¸åº”å­˜å‚¨æ˜æ–‡å¯†ç 
                loginTime: new Date().toISOString()
            };
            localStorage.setItem('currentUser', JSON.stringify(userData));
            document.getElementById('username').textContent = username;
            // éšè—ç™»å½•æŒ‰é’®ï¼Œæ˜¾ç¤ºç™»å‡ºæŒ‰é’®
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'inline-block';
            hideLoginModal();
        }

        // å¤„ç†ç™»å‡º
        function handleLogout() {
            localStorage.removeItem('currentUser');
            document.getElementById('username').textContent = 'æ¸¸å®¢';
            // æ˜¾ç¤ºç™»å½•æŒ‰é’®ï¼Œéšè—ç™»å‡ºæŒ‰é’®
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
        function showItemDetails(itemId) {
            const details = document.getElementById('itemDetails');
            details.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="width: 100%; height: 250px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                        <i class="fas fa-image fa-5x" style="color: #ddd;"></i>
                    </div>
                    <h4>ç¤ºä¾‹ä½œå“ ${itemId}</h4>
                    <p>è¿™æ˜¯ç¤ºä¾‹ä½œå“ ${itemId} çš„è¯¦ç»†ä¿¡æ¯ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºä»æœåŠ¡å™¨è·å–çš„çœŸå®ä½œå“ä¿¡æ¯ã€‚</p>
                </div>
                <div style="margin-top: 20px;">
                    <h5>ä½œå“ä¿¡æ¯</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>ä½œè€…:</strong> ç¤ºä¾‹ä½œè€…</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>åˆ›å»ºæ—¶é—´:</strong> 2023-01-01</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>å°ºå¯¸:</strong> 128x128 æ–¹å—</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>æ–¹å—ç±»å‹:</strong> ç¾Šæ¯›, æ··å‡åœŸ</li>
                        <li style="padding: 8px 0;"><strong>æè¿°:</strong> è¿™æ˜¯ä¸€ä¸ªç²¾ç¾çš„åƒç´ ç”»ä½œå“ï¼Œå±•ç¤ºäº†åˆ›ä½œè€…çš„æŠ€å·§å’Œåˆ›æ„ã€‚</li>
                    </ul>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" onclick="downloadItem(${itemId})" style="margin-right: 10px;"><i class="fas fa-download"></i> ä¸‹è½½</button>
                    <button class="btn btn-outline" onclick="favoriteItem(${itemId})"><i class="fas fa-heart"></i> æ”¶è—</button>
                </div>
            `;
            
            document.getElementById('itemModal').classList.add('active');
        }

        // éšè—é¡¹ç›®è¯¦æƒ…æ¨¡æ€æ¡†
        function hideItemModal() {
            document.getElementById('itemModal').classList.remove('active');
        }

        // ä¸‹è½½é¡¹ç›®
        function downloadItem(itemId) {
            alert(`æ­£åœ¨ä¸‹è½½ä½œå“ ${itemId}... åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè§¦å‘æ–‡ä»¶ä¸‹è½½ã€‚`);
        }

                // åŠ è½½å¸‚åœºé¡¹ç›®

                async function loadMarketItems(sortBy = 'upload_time') {

                    try {

                        const response = await fetch('/api/market');

                        const marketData = await response.json();

                        

                        const marketGrid = document.getElementById('marketGrid');

                        const marketEmpty = document.getElementById('marketEmpty');

                        

                        if (marketData.length === 0) {

                            marketEmpty.style.display = 'block';

                            marketGrid.innerHTML = '';

                            return;

                        }

                        

                        marketEmpty.style.display = 'none';

                        

                        // æ ¹æ®é€‰æ‹©çš„æ’åºæ–¹å¼å¯¹æ•°æ®è¿›è¡Œæ’åº

                        let sortedData = [...marketData];

                        

                        switch(sortBy) {

                            case 'download_count':

                                sortedData.sort((a, b) => b.download_count - a.download_count);

                                break;

                            case 'favorites':

                                sortedData.sort((a, b) => b.favorites - a.favorites);

                                break;

                            case 'title':

                                sortedData.sort((a, b) => a.title.localeCompare(b.title));

                                break;

                            case 'upload_time':

                            default:

                                // æŒ‰ä¸Šä¼ æ—¶é—´æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰

                                sortedData.sort((a, b) => new Date(b.upload_time) - new Date(a.upload_time));

                                break;

                        }

                        

                        // æ¸…ç©ºç°æœ‰åˆ—è¡¨

                        marketGrid.innerHTML = '';

                        

                        // ä¸ºæ¯ä¸ªå¸‚åœºé¡¹ç›®åˆ›å»ºå¡ç‰‡

                        sortedData.forEach(item => {

                            const marketItem = document.createElement('div');

                            marketItem.className = 'market-item';

                            marketItem.dataset.id = item.id; // å­˜å‚¨é¡¹ç›®ID

                            

                            marketItem.innerHTML = `

                                <div class="market-item-img">

                                    <i class="fas fa-cube fa-3x" style="color: #4CAF50;"></i>

                                </div>

                                <div class="market-item-content">

                                    <h5>${item.title}</h5>

                                    <p>${item.description}</p>

                                    <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.9em; color: #666;">

                                        <span><i class="fas fa-user"></i> <a href="#" onclick="showUserStats('${item.author}'); return false;" style="color: #666; text-decoration: none;">${item.author}</a></span>

                                        <span><i class="fas fa-download"></i> ${item.download_count}</span>

                                    </div>

                                    <div style="margin-top: 10px;">

                                        <button class="btn" onclick="downloadMarketItem('${item.id}')" style="margin-right: 5px;"><i class="fas fa-download"></i> ä¸‹è½½</button>

                                        <button class="btn btn-outline" onclick="showItemDetails('${item.id}')"><i class="fas fa-info-circle"></i> è¯¦æƒ…</button>

                                    </div>

                                </div>

                            `;

                            

                            marketGrid.appendChild(marketItem);

                        });

                    } catch (error) {

                        console.error('åŠ è½½å¸‚åœºé¡¹ç›®å¤±è´¥:', error);

                        showMessage('åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½å¸‚åœºé¡¹ç›®: ' + error.message, 'error');

                    }

                }

        

                // æœç´¢å¸‚åœºé¡¹ç›®

                function searchMarketItems() {

                    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

                    

                    // è·å–æ‰€æœ‰å¸‚åœºé¡¹ç›®å…ƒç´ 

                    const marketItems = document.querySelectorAll('.market-item');

                    

                    marketItems.forEach(item => {

                        const title = item.querySelector('h5').textContent.toLowerCase();

                        const description = item.querySelector('p').textContent.toLowerCase();

                        const author = item.querySelector('.market-item-content div span:first-child').textContent.toLowerCase().replace('ğŸ‘¤ ', '');

                        

                        // æ£€æŸ¥æœç´¢è¯æ˜¯å¦åŒ¹é…æ ‡é¢˜ã€æè¿°æˆ–ä½œè€…

                        if (title.includes(searchTerm) || description.includes(searchTerm) || author.includes(searchTerm)) {

                            item.style.display = 'block';

                        } else {

                            item.style.display = 'none';

                        }

                    });

                    

                    // å¦‚æœæ²¡æœ‰åŒ¹é…é¡¹ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€

                    const visibleItems = document.querySelectorAll('.market-item[style*="display: block"], .market-item:not([style])');

                    const marketEmpty = document.getElementById('marketEmpty');

                    

                    if (visibleItems.length === 0 && searchTerm) {

                        marketEmpty.style.display = 'block';

                        marketEmpty.innerHTML = `

                            <i class="fas fa-search"></i>

                            <h3>æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</h3>

                            <p>æ²¡æœ‰æ‰¾åˆ°åŒ…å« "${searchTerm}" çš„ä½œå“</p>

                        `;

                    } else {

                        marketEmpty.style.display = 'none';

                    }

                }

        // ä¸‹è½½å¸‚åœºé¡¹ç›®
        async function downloadMarketItem(itemId) {
            try {
                // ç›´æ¥é‡å®šå‘åˆ°ä¸‹è½½é“¾æ¥
                window.location.href = `/api/market/${itemId}/download`;
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                showMessage('ä¸‹è½½å¤±è´¥', error.message, 'error');
            }
        }

        // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
        function showItemDetails(itemId) {
            // æŸ¥æ‰¾å¯¹åº”é¡¹ç›®
            const itemElement = document.querySelector(`.market-item[data-id="${itemId}"]`);
            if (!itemElement) return;
            
            // è·å–é¡¹ç›®ä¿¡æ¯ï¼ˆè¿™é‡Œç®€å•åœ°ä»DOMè·å–ï¼Œå®é™…åº”ç”¨ä¸­åº”ä»APIè·å–è¯¦ç»†ä¿¡æ¯ï¼‰
            const title = itemElement.querySelector('h5').textContent;
            const description = itemElement.querySelector('p').textContent;
            const author = itemElement.querySelector('.market-item-content div span:first-child').textContent.replace('ğŸ‘¤ ', '');
            
            const details = document.getElementById('itemDetails');
            details.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="width: 100%; height: 250px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                        <i class="fas fa-cube fa-5x" style="color: #4CAF50;"></i>
                    </div>
                    <h4>${title}</h4>
                    <p>${description}</p>
                </div>
                <div style="margin-top: 20px;">
                    <h5>ä½œå“ä¿¡æ¯</h5>
                    <ul style="list-style: none; padding: 0;">
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>ä½œè€…:</strong> ${author}</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>ä¸Šä¼ æ—¶é—´:</strong> å³æ—¶è·å–</li>
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;"><strong>ä¸‹è½½æ¬¡æ•°:</strong> å³æ—¶è·å–</li>
                        <li style="padding: 8px 0;"><strong>æè¿°:</strong> ${description}</li>
                    </ul>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" onclick="downloadMarketItem('${itemId}')" style="margin-right: 10px;"><i class="fas fa-download"></i> ä¸‹è½½</button>
                    <button class="btn btn-outline" onclick="favoriteItem('${itemId}')"><i class="fas fa-heart"></i> æ”¶è—</button>
                </div>
            `;
            
            document.getElementById('itemModal').classList.add('active');
        }

        // æ˜¾ç¤ºä¸Šä¼ æ¨¡æ€æ¡†
        function showUploadModal() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const user = localStorage.getItem('currentUser');
            if (!user) {
                showMessage('è¯·å…ˆç™»å½•', 'éœ€è¦ç™»å½•åæ‰èƒ½ä¸Šä¼ ä½œå“', 'warning');
                showLoginModal();
                return;
            }
            
            document.getElementById('uploadModal').classList.add('active');
        }

        // éšè—ä¸Šä¼ æ¨¡æ€æ¡†
        function hideUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
        }

        // ä¸Šä¼ ä½œå“åˆ°å¸‚åœº
        async function uploadToMarket() {
            const fileInput = document.getElementById('marketFileInput');
            const titleInput = document.getElementById('marketTitle');
            const descriptionInput = document.getElementById('marketDescription');
            
            if (!fileInput.files[0]) {
                showMessage('é”™è¯¯', 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
                return;
            }
            
            if (!titleInput.value.trim()) {
                showMessage('é”™è¯¯', 'è¯·è¾“å…¥ä½œå“æ ‡é¢˜', 'error');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const user = localStorage.getItem('currentUser');
            if (!user) {
                showMessage('é”™è¯¯', 'è¯·å…ˆç™»å½•', 'error');
                showLoginModal();
                return;
            }
            
            const userData = JSON.parse(user);
            
            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('author', userData.username);
                formData.append('title', titleInput.value.trim());
                formData.append('description', descriptionInput.value.trim() || 'é€šè¿‡SunPixelä¸Šä¼ çš„ç»“æ„æ–‡ä»¶');
                
                const response = await fetch('/api/market/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('ä¸Šä¼ æˆåŠŸ', 'ä½œå“å·²æˆåŠŸä¸Šä¼ åˆ°å¸‚åœº', 'success');
                    hideUploadModal();
                    // é‡æ–°åŠ è½½å¸‚åœºé¡¹ç›®
                    loadMarketItems();
                    // é‡ç½®è¡¨å•
                    document.getElementById('marketUploadForm').reset();
                } else {
                    throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                showMessage('ä¸Šä¼ å¤±è´¥', error.message, 'error');
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·ç»Ÿè®¡æ•°æ®
        async function showUserStats(username) {
            try {
                const response = await fetch(`/api/user/${encodeURIComponent(username)}`);
                const userData = await response.json();
                
                if (userData.error) {
                    throw new Error(userData.error);
                }
                
                const content = document.getElementById('userStatsContent');
                let projectsHtml = '';
                
                if (userData.projects.length > 0) {
                    userData.projects.forEach(project => {
                        projectsHtml += `
                        <div class="market-item" style="margin-bottom: 10px; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${project.title}</strong>
                                    <div style="font-size: 0.9em; color: #666; margin-top: 4px;">${project.description}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div><i class="fas fa-download"></i> ${project.download_count} æ¬¡</div>
                                    <div><i class="fas fa-heart"></i> ${project.favorites} æ”¶è—</div>
                                </div>
                            </div>
                        </div>`;
                    });
                } else {
                    projectsHtml = '<p style="text-align: center; color: #666;">è¯¥ç”¨æˆ·æš‚æ— ä¸Šä¼ ä½œå“</p>';
                }
                
                content.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h4 style="color: var(--primary-color); margin-bottom: 5px;">${userData.username}</h4>
                        <p>ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯</p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">${userData.total_uploads}</div>
                            <div style="color: #666;">æ€»ä¸Šä¼ æ•°</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">${userData.total_downloads}</div>
                            <div style="color: #666;">æ€»ä¸‹è½½æ•°</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary-color);">${userData.total_favorites}</div>
                            <div style="color: #666;">æ€»æ”¶è—æ•°</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h5 style="margin-bottom: 10px; color: var(--primary-color); border-bottom: 1px solid #eee; padding-bottom: 8px;">ç”¨æˆ·ä½œå“</h5>
                        ${projectsHtml}
                    </div>
                `;
                
                document.getElementById('userStatsModal').classList.add('active');
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ç»Ÿè®¡å¤±è´¥:', error);
                showMessage('åŠ è½½å¤±è´¥', 'æ— æ³•åŠ è½½ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯: ' + error.message, 'error');
            }
        }

        // æ”¶è—é¡¹ç›®
        async function favoriteItem(itemId) {
            try {
                const response = await fetch(`/api/market/${itemId}/favorite`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('å·²æ”¶è—', 'ä½œå“å·²æ·»åŠ åˆ°æ”¶è—', 'success');
                    
                    // æ›´æ–°UIä¸­çš„æ”¶è—æ•°ï¼ˆå¦‚æœåœ¨è¯¦æƒ…é¡µï¼‰
                    const favoriteBtn = document.querySelector(`.market-item[data-id="${itemId}"] .btn-outline[onclick*="favoriteItem"]`);
                    if (favoriteBtn) {
                        // è¿™é‡Œå¯ä»¥æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€æˆ–è®¡æ•°ï¼Œä½†éœ€è¦ä»APIè·å–æœ€æ–°æ•°æ®
                    }
                } else {
                    throw new Error(result.error || 'æ”¶è—å¤±è´¥');
                }
            } catch (error) {
                console.error('æ”¶è—å¤±è´¥:', error);
                showMessage('æ”¶è—å¤±è´¥', error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            
            // åŠ è½½å¸‚åœºé¡¹ç›®
            loadMarketItems();
            
            // å¸‚åœºä¸Šä¼ æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('uploadMarketBtn').addEventListener('click', showUploadModal);
            document.getElementById('closeUploadModal').addEventListener('click', hideUploadModal);
            
            // å¸‚åœºä¸Šä¼ è¡¨å•æäº¤
            document.getElementById('marketUploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                uploadToMarket();
            });
            
            // æ’åºä¸‹æ‹‰èœå•äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('sortSelect').addEventListener('change', function() {
                loadMarketItems(this.value);
            });
            
            // æœç´¢æ¡†äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('searchInput').addEventListener('input', searchMarketItems);
            
            // ç”¨æˆ·ç»Ÿè®¡æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('closeUserStatsModal').addEventListener('click', function() {
                document.getElementById('userStatsModal').classList.remove('active');
            });
            
            document.getElementById('userStatsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    document.getElementById('userStatsModal').classList.remove('active');
                }
            });
            
            // ç™»å½•ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('loginBtn').addEventListener('click', showLoginModal);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('closeLoginModal').addEventListener('click', hideLoginModal);
            document.getElementById('closeItemModal').addEventListener('click', hideItemModal);
            document.getElementById('closeUploadModal').addEventListener('click', hideUploadModal);
            
            // ç™»å½•è¡¨å•æäº¤
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                handleLogin(username, password);
            });
            
            document.getElementById('guestLoginBtn').addEventListener('click', function() {
                handleLogin('æ¸¸å®¢_' + Date.now().toString().substr(-4), '');
            });

            // ç›‘å¬æœ¬åœ°å­˜å‚¨å˜åŒ–ï¼Œå®ç°è·¨æ ‡ç­¾é¡µç™»å½•çŠ¶æ€åŒæ­¥
            window.addEventListener('storage', function(e) {
                if (e.key === 'currentUser') {
                    checkLoginStatus(); // å½“æœ¬åœ°å­˜å‚¨ä¸­çš„ç”¨æˆ·ä¿¡æ¯æ”¹å˜æ—¶ï¼Œæ›´æ–°UI
                }
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('loginModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideLoginModal();
                }
            });
            
            document.getElementById('itemModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideItemModal();
                }
            });
            
            document.getElementById('uploadModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideUploadModal();
                }
            });
        });
    </script>
</body>
</html>