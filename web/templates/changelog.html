<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>更新记录 - SunPixel</title>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2ecc71;
            --dark-bg: #1a1a1a;
            --light-bg: #f8f9fa;
            --text-color: #333;
            --text-light: #666;
            --border-color: #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--light-bg);
            color: var(--text-color);
            min-height: 100vh;
        }
        
        /* 导航栏 */
        .navbar {
            background: white;
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .logo h1 {
            font-size: 24px;
            color: var(--primary-color);
        }
        
        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }
        
        .nav-links a {
            text-decoration: none;
            color: var(--text-color);
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .nav-links a:hover,
        .nav-links a.active {
            background: var(--primary-color);
            color: white;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-info span {
            font-weight: 500;
            color: var(--text-color);
        }
        
        /* 主要内容 */
        .main-content {
            max-width: 1200px;
            margin: 80px auto 20px;
            padding: 0 20px;
        }
        
        .page-header {
            margin-bottom: 30px;
        }
        
        .page-header h2 {
            font-size: 28px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 更新记录容器 */
        .changelog-container {
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            padding: 40px;
            margin-bottom: 30px;
        }
        
        .changelog-item {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        
        .changelog-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .changelog-date {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 15px;
            padding: 10px 0;
            border-bottom: 2px solid var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .changelog-content {
            line-height: 1.8;
            color: var(--text-color);
            font-size: 16px;
        }
        
        .version-badge {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .changelog-content h3 {
            color: var(--primary-color);
            margin: 25px 0 15px;
            font-size: 18px;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .changelog-content h4 {
            color: var(--text-color);
            margin: 20px 0 10px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .changelog-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .changelog-content li {
            margin-bottom: 10px;
            position: relative;
            padding-left: 10px;
            line-height: 1.6; /* 修复换行问题 */
        }
        
        .changelog-content li:before {
            content: "•";
            color: var(--primary-color);
            font-weight: bold;
            position: absolute;
            left: -10px;
        }
        
        .changelog-content code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #e74c3c;
        }
        
        .changelog-content p {
            margin-bottom: 15px;
            line-height: 1.6; /* 修复换行问题 */
        }
        
        /* 标签样式 */
        .update-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
            margin-bottom: 5px;
        }
        
        .tag-new {
            background: #d4edda;
            color: #155724;
        }
        
        .tag-fix {
            background: #f8d7da;
            color: #721c24;
        }
        
        .tag-improve {
            background: #fff3cd;
            color: #856404;
        }
        
        .tag-feature {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        /* 时间线样式 */
        .timeline-dot {
            position: absolute;
            left: -20px;
            top: 0;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 3px var(--primary-color);
        }
        
        .changelog-item:before {
            content: '';
            position: absolute;
            left: -14px;
            top: 12px;
            bottom: -30px;
            width: 2px;
            background: var(--border-color);
        }
        
        .changelog-item:last-child:before {
            display: none;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        /* 响应式 */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .changelog-container {
                padding: 20px;
            }
            
            .changelog-date {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .timeline-dot,
            .changelog-item:before {
                display: none;
            }
        }
        
        /* 加载动画 */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .loading i {
            font-size: 32px;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-sun"></i>
                <h1>SunPixel</h1>
            </div>
            <ul class="nav-links">
                <li><a href="/"><i class="fas fa-home"></i> 控制台</a></li>
                <li><a href="/history"><i class="fas fa-history"></i> 历史记录</a></li>
                <li><a href="/market"><i class="fas fa-store"></i> 市场</a></li>
                <li><a href="/changelog" class="active"><i class="fas fa-clipboard-list"></i> 更新记录</a></li>
            </ul>
            <div class="user-info">
                <span id="username">游客</span>
                <button class="btn btn-outline btn-sm" id="loginBtn">登录</button>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="main-content">
        <div class="page-header">
            <h2><i class="fas fa-clipboard-list"></i> 更新记录</h2>
        </div>
        
        <div class="changelog-container" id="changelogContainer">
            <!-- 动态加载更新记录 -->
            <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>加载更新记录中...</p>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="modal" id="loginModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000;">
        <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative;">
            <span class="modal-close" id="closeLoginModal" style="position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: var(--text-light);">&times;</span>
            <div class="modal-title" style="font-size: 20px; margin-bottom: 20px; color: var(--primary-color);">用户登录</div>
            <form class="login-form" id="loginForm">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color);">用户名</label>
                    <input type="text" class="form-control" id="loginUsername" placeholder="请输入用户名" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label" style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color);">密码</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="请输入密码" required style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px;">
                </div>
                <button type="submit" class="btn" style="display: inline-block; padding: 12px 24px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.3s; width: 100%;">登录</button>
                <button type="button" class="btn btn-outline" id="guestLoginBtn" style="background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); display: inline-block; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.3s; width: 100%; margin-top: 10px;">游客访问</button>
            </form>
        </div>
    </div>

    <script>
        // 检查登录状态
        function checkLoginStatus() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    document.getElementById('username').textContent = userData.username;
                } catch (e) {
                    console.error('解析用户信息失败:', e);
                }
            } else {
                document.getElementById('username').textContent = '游客';
            }
        }

        // 显示登录模态框
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        // 隐藏登录模态框
        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        // 处理登录
        function handleLogin(username, password) {
            // 这里可以向后端验证用户信息，当前为模拟实现
            const userData = {
                username: username,
                password: password, // 注意：实际应用中不应存储明文密码
                loginTime: new Date().toISOString()
            };
            localStorage.setItem('currentUser', JSON.stringify(userData));
            document.getElementById('username').textContent = username;
            hideLoginModal();
        }

        // 从API获取更新记录
        async function loadChangelog() {
            try {
                const response = await fetch('/api/changelog');
                const changelogs = await response.json();
                
                const container = document.getElementById('changelogContainer');
                
                if (changelogs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h3>暂无更新记录</h3>
                            <p>还没有发布任何更新</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                changelogs.forEach(log => {
                    html += `
                        <div class="changelog-item">
                            <div class="changelog-date">
                                <span>${log.date}</span>
                            </div>
                            <div class="changelog-content">${formatChangelogContent(log.content)}</div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            } catch (error) {
                console.error('加载更新记录失败:', error);
                document.getElementById('changelogContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>加载失败</h3>
                        <p>无法加载更新记录: ${error.message}</p>
                    </div>
                `;
            }
        }

        // 格式化更新记录内容（简单Markdown处理）
        function formatChangelogContent(content) {
            // 简单的Markdown转换，特别注意换行处理
            let html = content
                .replace(/^### (.*$)/gm, '<h5>$1</h5>')  // ### 标题
                .replace(/^## (.*$)/gm, '<h4>$1</h4>')   // ## 标题
                .replace(/^# (.*$)/gm, '<h3>$1</h3>')    // # 标题
                .replace(/^\> (.*$)/gm, '<blockquote>$1</blockquote>') // 引用
                .replace(/\*\*(.*)\*\*/gm, '<strong>$1</strong>') // 粗体
                .replace(/\*(.*)\*/gm, '<em>$1</em>')     // 斜体
                .replace(/\n\n/gm, '<br><br>')           // 段落换行
                .replace(/\n/gm, '<br>');                // 行内换行
            
            // 处理列表项
            html = html.replace(/^- (.*$)/gm, '<li>$1</li>');
            if (html.includes('<li>')) {
                // 将连续的<li>标签包裹在<ul>中
                html = html.replace(/(<li>.*?)(?=<\/ul>|<h\d>|<div|$)/gs, function(match) {
                    if (match.includes('<li>')) {
                        return '<ul>' + match + '</ul>';
                    }
                    return match;
                });
            }
            
            return html;
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadChangelog();
            
            // 登录相关事件监听器
            document.getElementById('loginBtn').addEventListener('click', showLoginModal);
            document.getElementById('closeLoginModal').addEventListener('click', hideLoginModal);
            
            // 登录表单提交
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                handleLogin(username, password);
            });
            
            document.getElementById('guestLoginBtn').addEventListener('click', function() {
                handleLogin('游客_' + Date.now().toString().substr(-4), '');
            });

            // 点击模态框外部关闭
            document.getElementById('loginModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideLoginModal();
                }
            });
        });
    </script>
</body>
</html>